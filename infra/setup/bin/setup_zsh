#! /usr/bin/env bash

# check that DOTFILES variable is defined
# shellcheck disable=SC1090
source "${BASH_SOURCE%/*}/../check_dotfiles_variable.sh"

source "$DOTFILES/infra/scripts/prompts.sh"

zsh_path="$(command -v zsh)"

info "Setting up zsh"

# add `zsh` to allowed shells if not already added
grep -q "$zsh_path" /etc/shells || {
  info "Using sudo access to add '$zsh_path' to /etc/shells"
  sudo sh -c "printf '%s\n' '$zsh_path' >> /etc/shells" && {
    success "Added $zsh_path to /etc/shells"
  }
}

# change login shell to brew `zsh` if it isn't already
[ "$SHELL" = "$zsh_path" ] || {
  info "Using sudo access to change default shell to '$zsh_path'"
  chsh -s "$zsh_path" && success "Changed login shell to $zsh_path"
}

info "Installing plugins"

# TODO: clean this up
BREW_PREFIX="$(brew --prefix)"
sudo chown -R "$(whoami)" "$BREW_PREFIX/share/zsh" "$BREW_PREFIX/share/zsh/site-functions"
chmod u+w "$BREW_PREFIX/share/zsh" "$BREW_PREFIX/share/zsh/site-functions"

# install zinit & its associated plugins
# `zinit self-update` is a recommended post-install step which runs `zcompile`
# to squeeze the last bit of performance
# TODO: make this less black boxy
zsh -i -c 'zinit self-update' > /dev/null

# apply ZLE syntax highlighting overrides
fast-theme "$DOTFILES/zsh/zle-fsh-theme-overlay.ini"

success "Completed zsh setup"
